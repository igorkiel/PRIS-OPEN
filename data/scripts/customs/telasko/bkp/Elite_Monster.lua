local eliteMonsters = {
    ["giant spider"] = {
        elites = {
            {skullType = SKULL_WHITE, effect = CONST_ME_MAGIC_RED, percentageIncrease = 0.25, chance = 10},
            {skullType = SKULL_RED, effect = CONST_ME_FIREATTACK, percentageIncrease = 0.5, chance = 8},
            {skullType = SKULL_BLACK, effect = CONST_ME_ENERGYHIT, percentageIncrease = 1.0, chance = 4}
        },
        eliteLoot = {
            {itemId = 2125, count = 1, chance = 100}, -- 100% chance
            {itemId = 2152, count = 10, chance = 105}, -- 25% chance de 10 moedas de platina
            {itemId = 2160, count = 1, chance = 10}, -- 10% chance de 1 cristal
        }
    },
    ["cyclops"] = {
        elites = {
            {skullType = SKULL_WHITE, effect = CONST_ME_MAGIC_GREEN, percentageIncrease = 0.25, chance = 10},
            {skullType = SKULL_RED, effect = CONST_ME_FIREATTACK, percentageIncrease = 0.5, chance = 8},
            {skullType = SKULL_BLACK, effect = CONST_ME_ENERGYHIT, percentageIncrease = 1.0, chance = 4}
        },
		eliteLoot = {
            {itemId = 2125, count = 1, chance = 100}, -- 100% chance
            {itemId = 2152, count = 10, chance = 105}, -- 25% chance de 10 moedas de platina
            {itemId = 2160, count = 1, chance = 10}, -- 10% chance de 1 cristal
        }
    },
	["demon"] = {
        elites = {
            {skullType = SKULL_WHITE, effect = CONST_ME_MAGIC_GREEN, percentageIncrease = 0.25, chance = 10},
            {skullType = SKULL_RED, effect = CONST_ME_FIREATTACK, percentageIncrease = 0.5, chance = 8},
            {skullType = SKULL_BLACK, effect = CONST_ME_ENERGYHIT, percentageIncrease = 1.0, chance = 4}
        },
		eliteLoot = {
            {itemId = 2125, count = 1, chance = 100}, -- 100% chance
            {itemId = 2152, count = 10, chance = 105}, -- 25% chance de 10 moedas de platina
            {itemId = 2160, count = 1, chance = 10}, -- 10% chance de 1 cristal
        }
    },
	["black knight"] = {
        elites = {
            {skullType = SKULL_WHITE, effect = CONST_ME_MAGIC_GREEN, percentageIncrease = 0.25, chance = 10},
            {skullType = SKULL_RED, effect = CONST_ME_FIREATTACK, percentageIncrease = 0.5, chance = 8},
            {skullType = SKULL_BLACK, effect = CONST_ME_ENERGYHIT, percentageIncrease = 1.0, chance = 4}
        },
		eliteLoot = {
            {itemId = 2125, count = 1, chance = 100}, -- 100% chance
            {itemId = 2152, count = 10, chance = 105}, -- 25% chance de 10 moedas de platina
            {itemId = 2160, count = 1, chance = 10}, -- 10% chance de 1 cristal
        }
    },
	["minotaur"] = {
        elites = {
            {skullType = SKULL_WHITE, effect = CONST_ME_MAGIC_GREEN, percentageIncrease = 0.25, chance = 10},
            {skullType = SKULL_RED, effect = CONST_ME_FIREATTACK, percentageIncrease = 0.5, chance = 8},
            {skullType = SKULL_BLACK, effect = CONST_ME_ENERGYHIT, percentageIncrease = 1.0, chance = 4}
        },
		eliteLoot = {
            {itemId = 2125, count = 1, chance = 100}, -- 100% chance
            {itemId = 2152, count = 10, chance = 105}, -- 25% chance de 10 moedas de platina
            {itemId = 2160, count = 1, chance = 10}, -- 10% chance de 1 cristal
        }
    },
	["minotaur guard"] = {
        elites = {
            {skullType = SKULL_WHITE, effect = CONST_ME_MAGIC_GREEN, percentageIncrease = 0.25, chance = 10},
            {skullType = SKULL_RED, effect = CONST_ME_FIREATTACK, percentageIncrease = 0.5, chance = 8},
            {skullType = SKULL_BLACK, effect = CONST_ME_ENERGYHIT, percentageIncrease = 1.0, chance = 4}
        },
		eliteLoot = {
            {itemId = 2125, count = 1, chance = 100}, -- 100% chance
            {itemId = 2152, count = 10, chance = 105}, -- 25% chance de 10 moedas de platina
            {itemId = 2160, count = 1, chance = 10}, -- 10% chance de 1 cristal
        }
    },
	["minotaur archer"] = {
        elites = {
            {skullType = SKULL_WHITE, effect = CONST_ME_MAGIC_GREEN, percentageIncrease = 0.25, chance = 10},
            {skullType = SKULL_RED, effect = CONST_ME_FIREATTACK, percentageIncrease = 0.5, chance = 8},
            {skullType = SKULL_BLACK, effect = CONST_ME_ENERGYHIT, percentageIncrease = 1.0, chance = 4}
        },
		eliteLoot = {
            {itemId = 2125, count = 1, chance = 100}, -- 100% chance
            {itemId = 2152, count = 10, chance = 105}, -- 25% chance de 10 moedas de platina
            {itemId = 2160, count = 1, chance = 10}, -- 10% chance de 1 cristal
        }
    },
	["orc"] = {
        elites = {
            {skullType = SKULL_WHITE, effect = CONST_ME_MAGIC_GREEN, percentageIncrease = 0.25, chance = 10},
            {skullType = SKULL_RED, effect = CONST_ME_FIREATTACK, percentageIncrease = 0.5, chance = 8},
            {skullType = SKULL_BLACK, effect = CONST_ME_ENERGYHIT, percentageIncrease = 1.0, chance = 4}
        },
		eliteLoot = {
            {itemId = 2125, count = 1, chance = 100}, -- 100% chance
            {itemId = 2152, count = 10, chance = 105}, -- 25% chance de 10 moedas de platina
            {itemId = 2160, count = 1, chance = 10}, -- 10% chance de 1 cristal
        }
    },
	["orc spearman"] = {
        elites = {
            {skullType = SKULL_WHITE, effect = CONST_ME_MAGIC_GREEN, percentageIncrease = 0.25, chance = 10},
            {skullType = SKULL_RED, effect = CONST_ME_FIREATTACK, percentageIncrease = 0.5, chance = 8},
            {skullType = SKULL_BLACK, effect = CONST_ME_ENERGYHIT, percentageIncrease = 1.0, chance = 4}
        },
		eliteLoot = {
            {itemId = 2125, count = 1, chance = 100}, -- 100% chance
            {itemId = 2152, count = 10, chance = 105}, -- 25% chance de 10 moedas de platina
            {itemId = 2160, count = 1, chance = 10}, -- 10% chance de 1 cristal
        }
    },
	["orc warrior"] = {
        elites = {
            {skullType = SKULL_WHITE, effect = CONST_ME_MAGIC_GREEN, percentageIncrease = 0.25, chance = 10},
            {skullType = SKULL_RED, effect = CONST_ME_FIREATTACK, percentageIncrease = 0.5, chance = 8},
            {skullType = SKULL_BLACK, effect = CONST_ME_ENERGYHIT, percentageIncrease = 1.0, chance = 4}
        },
		eliteLoot = {
            {itemId = 2125, count = 1, chance = 100}, -- 100% chance
            {itemId = 2152, count = 10, chance = 105}, -- 25% chance de 10 moedas de platina
            {itemId = 2160, count = 1, chance = 10}, -- 10% chance de 1 cristal
        }
    }
}

local function applyEliteStats(monster, skullType, percentageIncrease)
    monster:setElite(true)
    
    local maxHealth = monster:getMaxHealth() * (1 + percentageIncrease)
    monster:setMaxHealth(maxHealth)
    monster:setHealth(maxHealth)

    local newSpeed = monster:getSpeed() * (1 + percentageIncrease)
    monster:setSpeed(newSpeed)

    local newMinDamage = monster:getMinDamage() * (1 + percentageIncrease)
    local newMaxDamage = monster:getMaxDamage() * (1 + percentageIncrease)
    monster:setDamage(newMinDamage, newMaxDamage)

    local newExperience = monster:getExperience() * (1 + percentageIncrease)
    monster:setExperience(newExperience)

    local lootMultiplier = 1 + percentageIncrease
    monster:setLootMultiplier(lootMultiplier)

    monster:setSkull(skullType)
end

local function applyEliteLoot(monster, eliteLootTable)
    for _, loot in ipairs(eliteLootTable) do
        if math.random(100) <= loot.chance then
            monster:addItem(loot.itemId, loot.count)
        end
    end
end

local function spawnEliteMonster(player, target, eliteData, position)
    local targetName = target:getName():lower()
    for i = 1, 5 do
        addEvent(function()
            position:sendMagicEffect(CONST_ME_TELEPORT)
        end, i * 1000)
    end

    addEvent(function()
        local eliteMonster = Game.createMonster(targetName, position, true, true)
        if eliteMonster then
            applyEliteStats(eliteMonster, eliteData.skullType, eliteData.percentageIncrease)
            position:sendMagicEffect(eliteData.effect)
            -- eliteMonster:say("An elite " .. eliteMonster:getName() .. " has appeared!", TALKTYPE_MONSTER_SAY)

            local monsterConfig = eliteMonsters[targetName]
            if monsterConfig and monsterConfig.eliteLoot then
                applyEliteLoot(eliteMonster, monsterConfig.eliteLoot)
            end
        end
    end, 5000)
end


local function onKillEliteChance(player, target, lastHit)
    if not target or not target:isMonster() then
        return true
    end

    if target:getStorageValue("eliteSpawned") == 1 then
        return true
    end
    target:setStorageValue("eliteSpawned", 1)

    if target:getSkull() ~= SKULL_NONE then
        return true
    end

    local targetName = target:getName():lower()
    local monsterConfig = eliteMonsters[targetName]

    if monsterConfig then
        local eliteData = monsterConfig.elites[math.random(#monsterConfig.elites)]

        if math.random(100) <= eliteData.chance then
            local targetPos = target:getPosition()
            spawnEliteMonster(player, target, eliteData, targetPos)
        else
        end
    else
    end

    return true
end

local registeredMonsters = {}

local function registerMonsterEvents()
    for monsterName, _ in pairs(eliteMonsters) do
        if not registeredMonsters[monsterName] then
            local eventName = monsterName:gsub(" ", "") .. "EliteSpawn"
            local creatureEvent = CreatureEvent(eventName)

            function creatureEvent.onKill(player, target, lastHit)
                return onKillEliteChance(player, target, lastHit)
            end

            creatureEvent:register()
            registeredMonsters[monsterName] = true
        end
    end
end

local loginEvent = CreatureEvent("RegisterEliteEventsOnLogin")
function loginEvent.onLogin(player)
    for monsterName, _ in pairs(eliteMonsters) do
        local eventName = monsterName:gsub(" ", "") .. "EliteSpawn"
        player:registerEvent(eventName)
    end
    return true
end

loginEvent:register()
registerMonsterEvents()